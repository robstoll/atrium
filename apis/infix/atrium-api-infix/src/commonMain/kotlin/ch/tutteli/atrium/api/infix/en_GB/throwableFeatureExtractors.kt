//TODO 1.3.0 remove again and switch to core
@file:Suppress("DEPRECATION")

package ch.tutteli.atrium.api.infix.en_GB

import ch.tutteli.atrium.api.infix.en_GB.creating.Values
import ch.tutteli.atrium.creating.Expect
import ch.tutteli.atrium.logic._logic
import ch.tutteli.atrium.logic.causeIsA
import ch.tutteli.atrium.logic.creating.transformers.SubjectChangerBuilder
import ch.tutteli.atrium.logic.creating.typeutils.CharSequenceOrNumberOrChar
import kotlin.reflect.KClass

/**
 * Expects that the property [Throwable.message] of the subject of `this` expectation is not null,
 * creates an [Expect] for it and returns it.
 *
 * @return The newly created [Expect] for the property [Throwable.message] of the subject of `this` expectation.
 *
 * @sample ch.tutteli.atrium.api.infix.en_GB.samples.ThrowableFeatureExtractorSamples.messageFeature
 */
val <T : Throwable> Expect<T>.message: Expect<String>
    get() = it feature Throwable::message notToEqualNull o

/**
 * Expects that the property [Throwable.message] of the subject of `this` expectation is not null and
 * holds all assertions the given [assertionCreator] creates for it and
 * returns an [Expect] for the current subject of `this` expectation.
 *
 * @return an [Expect] for the subject of `this` expectation.
 *
 * @sample ch.tutteli.atrium.api.infix.en_GB.samples.ThrowableFeatureExtractorSamples.message
 */
infix fun <T : Throwable> Expect<T>.message(assertionCreator: Expect<String>.() -> Unit): Expect<T> =
    it feature of(Throwable::message) { it notToEqualNull assertionCreator }

/**
 * Expects that the property [Throwable.message] of the subject of `this` expectation is not null and contains
 * [expected]'s [toString] representation using a non-disjoint search.
 **
 * Notice that a runtime check applies which assures that only [CharSequence], [Number] and [Char] are passed.
 * This function expects [CharSequenceOrNumberOrChar] (which is a typealias for [Any]) for your convenience,
 * so that you can mix [String] and [Int] for instance.
 *
 * @return an [Expect] for the subject of `this` expectation.
 *
 * @sample ch.tutteli.atrium.api.infix.en_GB.samples.ThrowableFeatureExtractorSamples.messageToContain
 *
 * @since 0.17.0
 */
infix fun <T : Throwable> Expect<T>.messageToContain(expected: CharSequenceOrNumberOrChar): Expect<T> =
    this messageToContain values(expected)

/**
 * Expects that the property [Throwable.message] of the subject of `this` expectation is not null and contains
 * [values]'s [toString] representation using a non-disjoint search.
 **
 * Notice that a runtime check applies which assures that only [CharSequence], [Number] and [Char] are passed
 * (this function expects `Any` for your convenience, so that you can mix [String] and [Int] for instance).
 *
 * @param values The values which are expected to be contained within [Throwable.message]
 *   -- use the function `values(t, ...)` to create a [Values].
 *
 * @return an [Expect] for the subject of `this` expectation.
 *
 * @sample ch.tutteli.atrium.api.infix.en_GB.samples.ThrowableFeatureExtractorSamples.messageFeature
 *
 * @since 0.17.0
 */
infix fun <T : Throwable> Expect<T>.messageToContain(values: Values<Any>): Expect<T> =
    message { toContain(values) }


/**
 * Expects that the property [Throwable.cause] of the subject *is a* [ExpectedThrowableT] or a subtype thereof,
 * creates an [Expect] of the [ExpectedThrowableT] type for it and returns it.
 *
 * @return The newly created [Expect] for the property [Throwable.cause] of the subject of `this` expectation
 *
 * @sample ch.tutteli.atrium.api.infix.en_GB.samples.ThrowableFeatureExtractorSamples.causeFeature
 *
 * @since 0.12.0
 */
inline fun <reified ExpectedThrowableT : Throwable> Expect<out Throwable>.cause(): Expect<ExpectedThrowableT> =
    causeToBeAnInstanceOf(ExpectedThrowableT::class).transform()

@PublishedApi // in order that _logic does not become part of the API we have this extra function
internal fun <ExpectedThrowableT : Throwable> Expect<out Throwable>.causeToBeAnInstanceOf(
    kClass: KClass<ExpectedThrowableT>
): SubjectChangerBuilder.ExecutionStep<Throwable?, ExpectedThrowableT> = _logic.causeIsA(kClass)


/**
 * Expects that the property [Throwable.cause] of the subject *is a* [ExpectedThrowableT] or a subtype thereof and
 * holds all assertions the given [assertionCreator] creates for it.
 *
 * Notice, in contrast to other assertion functions which expect an [assertionCreator], this function returns not
 * [Expect] of the initial type, which was some type `T `, but an [Expect] of the specified type [ExpectedThrowableT].
 *
 * @return an [Expect] for the subject of `this` expectation.
 *
 * @sample ch.tutteli.atrium.api.infix.en_GB.samples.ThrowableFeatureExtractorSamples.cause
 *
 * @since 0.12.0
 */
inline infix fun <reified ExpectedThrowableT : Throwable> Expect<out Throwable>.cause(
    noinline assertionCreator: Expect<ExpectedThrowableT>.() -> Unit
): Expect<ExpectedThrowableT> = causeToBeAnInstanceOf(ExpectedThrowableT::class).transformAndAppend(assertionCreator)
